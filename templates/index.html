<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VigilantEye - Malware Detection</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <link rel="alternate icon" href="{{ url_for('static', filename='favicon.svg') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='theme.js') }}" defer></script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('home') }}">
      <i class="bi bi-shield-check"></i> VigilantEye
    </a>
    <div class="ms-auto d-flex align-items-center gap-3">
      <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Switch Theme">
        <i class="bi bi-moon-fill"></i>
      </button>
      <a href="{{ url_for('about') }}" class="btn btn-outline-info btn-sm">
        <i class="bi bi-info-circle"></i> About
      </a>
      {% if session.get('username') %}
        <span class="d-flex align-items-center gap-2" style="color: var(--text-primary);">
          <i class="bi bi-person-circle"></i> {{ session['username'] }}
        </span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-in-right"></i> Login
        </a>
        <a href="{{ url_for('signup') }}" class="btn btn-outline-info btn-sm">
          <i class="bi bi-person-plus"></i> Sign Up
        </a>
      {% endif %}
    </div>
  </div>
</nav>

<div class="container">
  <div class="card">
    <div class="text-center mb-4">
      <h1 class="logo">
        <i class="bi bi-shield-check"></i> VigilantEye
      </h1>
      <p style="color: var(--text-secondary);" class="fs-5">Advanced AI-Powered GIF Malware Detection</p>
      <p style="color: var(--text-secondary);">Upload your GIF file to scan for hidden threats and malicious payloads</p>
    </div>

    <form method="POST" enctype="multipart/form-data" id="uploadForm">
      <div class="upload-area" onclick="document.querySelector('input[type=file]').click()">
        <div class="upload-icon">
          <i class="bi bi-cloud-upload"></i>
        </div>
        <h5 class="text-white mb-3">Drag & Drop or Click to Upload</h5>
        <p style="color: var(--text-secondary);" class="mb-3">Supported format: .gif files only</p>
        <input type="file" class="form-control d-none" name="gif_file" accept=".gif" required id="fileInput" onchange="updateFileName(this)">
        <div id="fileName" class="text-primary mt-2"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-4" id="scanBtn">
        <i class="bi bi-search"></i> Scan for Malware
      </button>
    </form>

    {% if result %}
    <div class="result-box mt-4 {% if result[0] == 'infected' %}bg-danger{% else %}bg-success{% endif %}">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="mb-0">
          <i class="bi bi-{% if result[0] == 'infected' %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
          Scan Result
        </h4>
        <span class="status-badge {% if result[0] == 'infected' %}infected{% else %}clean{% endif %}">
          {{ result[0].upper() }}
        </span>
      </div>

      <div class="mb-3">
        <strong style="color: var(--text-secondary);">File:</strong>
        <code class="ms-2">{{ file_name }}</code>
      </div>

      {% if file_name %}
      <div class="text-center my-4 gif-preview">
        <img src="{{ url_for('static', filename='uploads/' + file_name) }}" 
             alt="Scanned GIF"
             class="img-fluid rounded"
             style="max-height: 300px;">
      </div>
      {% endif %}

      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <div class="p-3 rounded" style="background: var(--bg-overlay);">
            <small style="color: var(--text-secondary);" class="d-block mb-1">Detection Method</small>
            <strong class="d-block">
              <span class="method-badge">{{ result[1] }}</span>
            </strong>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-3 rounded" style="background: var(--bg-overlay);">
            <small style="color: var(--text-secondary);" class="d-block mb-1">Status</small>
            <strong class="d-block" style="color: {% if result[0] == 'infected' %}var(--danger-color){% else %}var(--success-color){% endif %};">
              {{ result[0].upper() }}
            </strong>
          </div>
        </div>
      </div>

      {% if payload %}
      <div class="mt-4">
        <h6 class="mb-2">
          <i class="bi bi-code-slash"></i> Extracted Payload:
        </h6>
        <pre class="p-3 rounded" style="background: var(--bg-overlay);">{{ payload }}</pre>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {% if history %}
    <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
      <h4 class="mb-0">
        <i class="bi bi-clock-history"></i> Scan History
      </h4>
      <a href="{{ url_for('download_report') }}" class="btn btn-warning">
        <i class="bi bi-download"></i> Download Report (CSV)
      </a>
    </div>

    <div class="history-container">
      {% for entry in history %}
      <div class="history-entry">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h6 class="mb-1">
              <i class="bi bi-file-earmark-image"></i> 
              <code>{{ entry.file_name }}</code>
            </h6>
            <div class="d-flex gap-2 flex-wrap mt-2">
              <span class="status-badge {% if entry.status == 'infected' %}infected{% else %}clean{% endif %}">
                {{ entry.status.upper() }}
              </span>
              <span class="method-badge">{{ entry.method }}</span>
            </div>
          </div>
        </div>
        {% if entry.payload %}
        <details class="mt-3">
          <summary class="text-primary cursor-pointer" style="cursor: pointer;">
            <i class="bi bi-chevron-down"></i> View Payload Details
          </summary>
          <pre class="p-3 rounded mt-2" style="background: var(--bg-overlay);">{{ entry.payload }}</pre>
        </details>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<div class="footer">
  <p>&copy; 2025 VigilantEye | AI-Powered Malware Detection | Built with Flask & PyTorch</p>
</div>

<script>
  function updateFileName(input) {
    const fileName = input.files[0]?.name;
    const fileNameDiv = document.getElementById('fileName');
    if (fileName) {
      fileNameDiv.innerHTML = `<i class="bi bi-file-earmark-check"></i> Selected: <strong>${fileName}</strong>`;
      fileNameDiv.style.color = 'var(--success-color)';
    }
  }

  document.getElementById('uploadForm').addEventListener('submit', function() {
    const btn = document.getElementById('scanBtn');
    btn.innerHTML = '<span class="loading-spinner"></span> Scanning...';
    btn.disabled = true;
  });
</script>

</body>
</html>
